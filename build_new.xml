<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="all" name="Validation, Diagnostics and build" xmlns:if="ant:if"
  xmlns:unless="ant:unless">

  <description> 
    ##################################################################### 
    # Project build file by Martin Holmes (mholmes@uvic.ca), 2023.      #
    # This build file processes the site content in the pages folder    #
    # to create a fully-realized site in both languages in the products #
    # folder.                                                           #
    ##################################################################### 
  </description>

  <property name="echo.separator" value="************************************************"/>
  
  <property name="saxon" value="${basedir}/utilities/saxon-he-10.jar"/>
  
  <!-- Set of content source files to process. -->
  <fileset id="sourceFiles" dir="${basedir}/pages">
    <include name="*.xml"/>
  </fileset>
  
  <!-- Images to push to the site folder. -->
  <fileset id="imgFiles" dir="${basedir}/img">
    <include name="*.*"/>
  </fileset>
  
  <!-- Fonts for the site. -->
  <fileset id="fonts" dir="${basedir}/fonts">
    <include name="*.*"/>
  </fileset>
  
  <target name="clean">
    <description>
      TARGET clean
      This target clears out old build products.
    </description>
    <echo message="${echo.separator}"/>
    <echo message="Cleaning up content from previous builds..."/>
    <mkdir dir="${basedir}/products"/>
    <delete includeemptydirs="true">
      <fileset dir="${basedir}/products">
        <include name="*"/>
        <include name="**/*"/>
      </fileset>
    </delete>
  </target>
  
  <target name="buildCss">
    <description>
      TARGET buildCss
      This builds the SCSS file to create CSS and map file for the output site.
    </description>
    <echo message="${echo.separator}"/>
    <echo message="Building SCSS source to create CSS file in HTML folder."/>
    <mkdir dir="${basedir}/products/css"/>
    <exec executable="sass">
      <arg value="${basedir}/css/endings.scss"/>
      <arg value="${basedir}/products/css/endings.css"/>
    </exec>
  </target>
 
  <target name="buildHtml">
    <description>
      TARGET buildHtml
      This target processes all the existing HTML files to 
      refresh any common components such as menus. It places
      the output into a temp folder so that it can be inspected
      before overwriting the originals.
    </description>
    <echo message="${echo.separator}"/>
    <echo message="Building all the site pages..."/>
    <java fork="true" classname="net.sf.saxon.Transform" classpath="${saxon}" failonerror="true" dir="${basedir}">
      <arg value="-s:xsl/build_new_html.xsl"/>
      <arg value="-xsl:xsl/build_new_html.xsl"/>
      <arg value="projDir=${basedir}/"/>
      <arg value="--suppressXsltNamespaceCheck:on"/>
    </java>
  </target>
  
  <target name="copyRequiredFiles">
    <copy todir="${basedir}/products/img">
      <fileset refid="imgFiles"/>
    </copy>
    <copy todir="${basedir}/products/fonts">
      <fileset refid="fonts"/>
    </copy>
    <zip basedir="${basedir}/logos" zipfile="${basedir}/products/logos.zip"/>
  </target>
  
  <target name="rsyncToLiveServer">
    <description>
      TARGET rsyncToLiveServer
      This pushes the content up to the endings/www folder on the nfs.hcmc.uvic.ca server.
      This will overwrite the existing site, but it will not delete any obsolete files.
    </description>
    <echo message="${echo.separator}"/>
    <echo message="Pushing content up to the live site."/>
    <exec executable="rsync" dir="${basedir}">
      <arg value="--stats"/>
      <arg value="--recursive"/>
      <arg value="--times"/>
      <arg value="--verbose"/>
      <arg value="--omit-dir-times"/>
      <!--<arg value="-\-delete"/>-->
      <arg line="-e ssh"/>
      <arg line="products/"/>
      <arg line="mholmes@nfs.hcmc.uvic.ca:/home1t/endings/www/"/>
    </exec>
  </target>

  <target name="all">
    <description> TARGET all 
      This target runs all the processes defined elsewhere in the file. </description>
    <antcall target="clean"/>
    <antcall target="buildCss"/>
    <antcall target="buildHtml"/>
    <antcall target="copyRequiredFiles"/>
  </target>

</project>
